# WebSocket Chat Server Test Plan

## 1. HTTP API Tests

### 1.1 `/colors` エンドポイント

#### 正常系
- **初期状態テスト**: サーバー起動直後、全ての色が利用可能であることを確認
- **1人参加後テスト**: 1人が参加した後、その色が利用不可になることを確認
- **複数人参加後テスト**: 複数人が参加した後、参加者の色が全て利用不可になることを確認
- **参加者離脱後テスト**: 参加者が離脱した後、その色が再び利用可能になることを確認

#### 異常系
- **存在しないパステスト**: `/colors` 以外のパスへのアクセスで404が返ることを確認
- **不正なHTTPメソッドテスト**: POST、PUT、DELETE等で適切にハンドリングされることを確認

## 2. WebSocket Tests

### 2.1 接続・切断テスト

#### 正常系
- **接続成功テスト**: 正常なWebSocket接続が確立できることを確認
- **切断テスト**: 接続を切断できることを確認

### 2.2 Startup Message テスト

#### 正常系
- **有効な色での参加テスト**: 利用可能な色で正常に参加できることを確認
- **joinメッセージ配信テスト**: 新規参加時に既存参加者にjoinメッセージが配信されることを確認

#### 異常系
- **色重複エラーテスト**: 既に使用中の色で参加しようとした時、接続が切断されることを確認
- **名前重複エラーテスト**: 既に使用中の名前で参加しようとした時、接続が切断されることを確認
- **存在しない色エラーテスト**: 定義されていない色で参加しようとした時、接続が切断されることを確認
- **不正なJSONテスト**: malformedなJSONを送信した時の適切なエラーハンドリングを確認
- **不正なメッセージ形式テスト**: 必須フィールドが不足している場合のエラーハンドリングを確認

### 2.3 Message テスト

#### 正常系
- **メッセージ送信テスト**: 参加者がメッセージを送信できることを確認
- **メッセージ配信テスト**: 送信されたメッセージが全参加者に配信されることを確認
- **メッセージ内容テスト**: 送信者の名前、色、メッセージ内容、タイムスタンプが正しく設定されることを確認

#### 異常系
- **未参加者メッセージテスト**: startup前にメッセージを送信した場合の動作を確認
- **空メッセージテスト**: 空文字列のメッセージを送信した場合の動作を確認

### 2.4 Leave Message テスト

#### 正常系
- **離脱メッセージ配信テスト**: 参加者が離脱した時、他の参加者にleaveメッセージが配信されることを確認
- **接続削除テスト**: 離脱後、該当の接続がサーバーから削除されることを確認

## 3. Integration Tests

### 3.1 複数クライアントテスト
- **2人チャットテスト**: 2人の参加者が相互にメッセージを送受信できることを確認
- **3人以上チャットテスト**: 3人以上の参加者が同時にチャットできることを確認
- **順次参加・離脱テスト**: 参加者が順次参加・離脱する際の動作を確認

### 3.2 負荷・境界値テスト
- **最大接続数テスト**: 利用可能な色数（7色）まで接続できることを確認
- **最大接続数超過テスト**: 8人目以降の参加者が適切に拒否されることを確認
- **長時間接続テスト**: 長時間接続を維持できることを確認

### 3.3 HTTPとWebSocketの連携テスト
- **色状態同期テスト**: WebSocketの参加・離脱がHTTP `/colors` エンドポイントに正しく反映されることを確認
- **リアルタイム更新テスト**: WebSocketの状態変化とHTTP APIの応答が同期していることを確認

## 4. Error Handling Tests

### 4.1 ネットワークエラー
- **接続突然切断テスト**: クライアントが突然切断された場合の適切なクリーンアップを確認
- **不正なWebSocketフレームテスト**: 不正なWebSocketフレームが送信された場合の動作を確認

### 4.2 サーバーエラー
- **JSON解析エラーテスト**: 不正なJSONが送信された場合のエラーハンドリングを確認
- **Schema検証エラーテスト**: Effect Schemaの検証エラーが適切に処理されることを確認

## Test Environment Setup

### テスト用設定
- **ポート**: 3001（本番用3000と分離）
- **ログレベル**: テスト実行時は最小限に抑制
- **タイムアウト**: 各テストケースに適切なタイムアウトを設定

### テストヘルパー
- **WebSocketクライアントヘルパー**: 接続、メッセージ送受信を簡単に行えるヘルパー関数
- **HTTPクライアントヘルパー**: `/colors` エンドポイントのテスト用ヘルパー
- **テストサーバー管理**: テストごとのサーバー起動・停止を管理

## Test Data

### 利用可能な色
```typescript
const colors = ["red", "green", "yellow", "blue", "magenta", "cyan", "white"];
```

### テスト用ユーザー
```typescript
const testUsers = [
  { name: "alice", color: "red" },
  { name: "bob", color: "blue" },
  { name: "charlie", color: "green" },
  // ...
];
```